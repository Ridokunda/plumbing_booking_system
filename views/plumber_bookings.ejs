<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeFixIt | <%= title %></title>
    <link rel="stylesheet" href="/stylesheets/custom.css">
    <!-- slider stylesheet -->
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css" />
    <!-- bootstrap core css -->
    <link rel="stylesheet" type="text/css" href="/stylesheets/bootstrap.css" />
    <!-- font awesome style -->
    <link rel="stylesheet" type="text/css" href="/stylesheets/font-awesome.min.css" />
    <!-- Custom styles for this template -->
    <link href="/stylesheets/style.css" rel="stylesheet" />
    <!-- responsive style -->
    <link href="/stylesheets/responsive.css" rel="stylesheet" />
</head>
<body>
    <div class="mybookings-container">
        <div style="width:100%; display:flex; align-items:center; justify-content:space-between;">
          <div class="mybookings-header">My Assigned Bookings</div>
        </div>
        <div class="search-filter-bar">
            <input type="text" id="searchInput" class="search-input" placeholder="Search bookings">
            <select id="statusFilter" class="status-filter">
                <option value="ALL">ALL STATUS</option>
                <option value="NEW">NEW</option>
                <option value="ASSIGNED">ASSIGNED</option>
                <option value="CANCELLED">CANCELLED</option>
                <option value="DECLINED">DECLINED</option>
                <option value="COMPLETED">COMPLETED</option>
                <option value="IN_PROGRESS">IN PROGRESS</option>
            </select>
        </div>
        <div class="bookings-grid" id="bookingsGrid">
            <% if (bookings && bookings.length) { %>
                <% bookings.forEach(booking => { %>
                    <div class="booking-card" data-status="<%= booking.status %>" data-type="<%= booking.type || booking.service_type %>" data-date="<%= booking.date_start %>" data-search="<%= (booking.customer_name || booking.customer_fullname || '') %> <%= booking.type || booking.service_type %> <%= booking.status %> <%= booking.date_start %>">
                        <div class="card-row card-row-top">
                            <div class="service-type">Service Type</div>
                            <span class="service-badge"><%= booking.type || booking.service_type %></span>
                        </div>
                        <div class="service-type" style="font-size:1.25em; margin-bottom:2px;"><%= booking.customer_name ? (booking.customer_name + ' ' + (booking.customer_surname || '')) : (booking.customer_fullname || 'Customer') %></div>
                        <div class="booking-date" data-date="<%= booking.date_start %>"></div>
                        <div class="card-row card-row-bottom">
                            <span class="status-label status-<%= booking.status %>"><%= booking.status %></span>
                        </div>
                        <div style="margin-top:8px; color:#666; font-size:0.9em;">
                            <strong>Description:</strong> <%= booking.des || booking.description || '' %>
                        </div>
                        <!-- photo section -->
                        <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;">
                            <% if (booking.before_photo) { %>
                                <div>Before:<br><img src="<%= booking.before_photo %>" class="booking-photo" style="max-width:150px; max-height:150px; display:block;"/></div>
                            <% } else if (booking.status !== 'NEW' && booking.status !== 'CANCELLED') { %>
                                <form class="photo-form" data-booking-id="<%= booking.idbookings %>" data-type="before" enctype="multipart/form-data" style="display:flex; gap:4px; align-items:center;">
                                    <input type="file" name="photo" accept="image/*" required />
                                    <button type="submit" style="background:#007bff;color:#fff;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;">Upload Before</button>
                                </form>
                            <% } %>
                            <% if (booking.after_photo) { %>
                                <div>After:<br><img src="<%= booking.after_photo %>" class="booking-photo" style="max-width:150px; max-height:150px; display:block;"/></div>
                            <% } else if (booking.status === 'COMPLETED') { %>
                                <form class="photo-form" data-booking-id="<%= booking.idbookings %>" data-type="after" enctype="multipart/form-data" style="display:flex; gap:4px; align-items:center;">
                                    <input type="file" name="photo" accept="image/*" required />
                                    <button type="submit" style="background:#007bff;color:#fff;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;">Upload After</button>
                                </form>
                            <% } %>
                        </div>
                        <div style="display:flex; gap:8px; margin-top:10px;">
                            <% if (booking.status !== 'COMPLETED' && booking.status !== 'CANCELLED') { %>
                                <button class="complete-booking-btn" data-booking-id="<%= booking.idbookings %>" style="background:#28a745; color:#fff; border:none; border-radius:8px; padding:8px 18px; font-size:1rem; cursor:pointer; transition:background 0.2s;">Mark as Complete</button>
                            <% } else { %>
                                <span style="color:#666; font-style:italic;">No actions available</span>
                            <% } %>
                        </div>
                        <div style="margin-top:10px;">
                            <label>Amount: $</label>
                            <input type="number" class="amount-input" data-booking-id="<%= booking.idbookings %>" value="<%= booking.amount || 50 %>" step="0.01" min="0" style="width:80px; padding:4px;">
                            <button class="update-amount-btn" data-booking-id="<%= booking.idbookings %>" style="background:#28a745; color:#fff; border:none; border-radius:4px; padding:4px 8px; cursor:pointer;">Update Amount</button>
                        </div>
                    </div>
                <% }); %>
            <% } else { %>
                <div style="padding:20px; color:#666;">No bookings assigned to you yet.</div>
            <% } %>
        </div>

        <div id="complete-message" style="margin:20px; display:none; padding:10px; border-radius:5px;"></div>
    </div>

    <script>
      // Format booking dates
      document.querySelectorAll('.booking-date').forEach(function(el) {
          var dateStr = el.getAttribute('data-date');
          if (dateStr) {
              var date = new Date(dateStr);
              var options = { weekday: 'long', year: 'numeric', month: 'long', day: '2-digit' };
              el.textContent = date.toLocaleDateString(undefined, options);
          }
      });

      // Search and filter (client-side)
      const searchInput = document.getElementById('searchInput');
      const statusFilter = document.getElementById('statusFilter');
      const bookingsGrid = document.getElementById('bookingsGrid');
      function filterBookings() {
          const searchVal = searchInput.value.toLowerCase();
          const statusVal = statusFilter.value;
          bookingsGrid.querySelectorAll('.booking-card').forEach(card => {
              const cardSearch = card.getAttribute('data-search').toLowerCase();
              const cardStatus = card.getAttribute('data-status');
              let show = cardSearch.includes(searchVal);
              if (statusVal !== 'ALL') {
                  show = show && cardStatus === statusVal;
              }
              card.style.display = show ? '' : 'none';
          });
      }
      searchInput.addEventListener('input', filterBookings);
      statusFilter.addEventListener('change', filterBookings);

      // Mark complete action (AJAX)
      document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('complete-booking-btn')) {
          const bookingId = e.target.getAttribute('data-booking-id');
          if (!confirm('Mark this booking as completed?')) return;
          fetch('/plumber/update-booking-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ booking_id: bookingId, status: 'COMPLETED' })
          }).then(r => r.json()).then(res => {
            const msg = document.getElementById('complete-message');
            msg.style.display = 'block';
            msg.textContent = res.message;
            if (res.success) {
              msg.style.backgroundColor = '#d4edda'; msg.style.color = '#155724'; msg.style.border = '1px solid #c3e6cb';
              // update UI
              const btn = document.querySelector(`button.complete-booking-btn[data-booking-id="${bookingId}"]`);
              if (btn) {
                const card = btn.closest('.booking-card');
                card.querySelector('.status-label').textContent = 'COMPLETED';
                card.querySelector('.status-label').className = 'status-label status_COMPLETED';
                btn.remove();
              }
            } else {
              msg.style.backgroundColor = '#f8d7da'; msg.style.color = '#721c24'; msg.style.border = '1px solid #f5c6cb';
            }
          }).catch(() => {
            const msg = document.getElementById('complete-message');
            msg.style.display = 'block'; msg.style.backgroundColor = '#f8d7da'; msg.style.color = '#721c24'; msg.style.border = '1px solid #f5c6cb';
            msg.textContent = 'An error occurred';
          });
        }
        if (e.target && e.target.classList.contains('update-amount-btn')) {
          console.log('Update amount button clicked');
          const bookingId = e.target.getAttribute('data-booking-id');
          const amount = document.querySelector(`.amount-input[data-booking-id="${bookingId}"]`).value;
          console.log('Booking ID:', bookingId, 'Amount:', amount);
          fetch('/plumber/update-amount', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ booking_id: bookingId, amount: parseFloat(amount) })
          }).then(r => r.json()).then(res => {
            console.log('Response:', res);
            alert(res.message);
          }).catch(err => {
            console.error('Error:', err);
            alert('An error occurred');
          });
        }
        // handle photo uploads
        if (e.target && e.target.closest('.photo-form')) {
          e.preventDefault();
          const form = e.target.closest('.photo-form');
          const bookingId = form.getAttribute('data-booking-id');
          const type = form.getAttribute('data-type');
          const fileInput = form.querySelector('input[type=file]');
          if (!fileInput.files.length) return;
          const fd = new FormData();
          fd.append('photo', fileInput.files[0]);
          fd.append('booking_id', bookingId);
          fd.append('type', type);
          fetch('/plumber/upload-photo', {
            method: 'POST',
            body: fd
          }).then(r => r.json()).then(res => {
            if (res.success) {
              alert(res.message);
              // reload page to show photo
              window.location.reload();
            } else {
              alert('Upload failed: ' + res.message);
            }
          }).catch(err => {
            console.error('Photo upload error', err);
            alert('An error occurred while uploading the photo');
          });
        }
      });
    </script>
</body>
</html>